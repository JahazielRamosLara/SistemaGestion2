{% extends "base.html" %}

{% block title %}Gestión de Remitentes{% endblock %}

{% block extra_css %}
<style>
    .management-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        margin-top: 30px;
    }

    .card-header-custom {
        background: linear-gradient(135deg, #6b8fa3 0%, #89a8bb 100%);
        padding: 25px 30px;
        border: none;
    }

    .card-header-custom h4 {
        color: white;
        font-weight: 600;
        font-size: 22px;
        margin: 0;
    }

    .card-body-custom {
        padding: 35px 40px;
    }

    /* Botón de volver */
    .btn-back {
        background: #e8e8e8;
        border: none;
        border-radius: 50px;
        padding: 12px 28px;
        color: #666;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
        margin-bottom: 25px;
    }

    .btn-back:hover {
        background: #ddd;
        color: #333;
        transform: translateY(-2px);
    }

    .btn-back i {
        font-size: 14px;
    }

    /* Tabla personalizada */
    .table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        border: 2px solid #f0f0f0;
        margin-top: 20px;
    }

    .table {
        margin: 0;
    }

    .table thead {
        background: linear-gradient(135deg, #6b8fa3 0%, #89a8bb 100%);
    }

    .table thead th {
        color: #2c3e50;
        font-weight: 600;
        font-size: 14px;
        padding: 18px 20px;
        border: none;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .table tbody td {
        padding: 18px 20px;
        color: #4a5568;
        font-size: 14px;
        vertical-align: middle;
        border-bottom: 1px solid #f0f0f0;
    }

    .table tbody tr {
        transition: all 0.2s ease;
    }

    .table tbody tr:hover {
        background: #f8f9fa;
    }

    .table tbody tr:last-child td {
        border-bottom: none;
    }

    /* Fila inactiva */
    .table tbody tr.table-light {
        background: #f8f9fa;
        opacity: 0.7;
    }

    .table tbody tr.table-light:hover {
        background: #f1f3f5;
        opacity: 0.85;
    }

    /* Botones de acción en tabla */
    .btn-toggle-activo {
        border: none;
        border-radius: 50px;
        padding: 7px 20px;
        font-weight: 600;
        font-size: 12px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }

    .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(239, 68, 68, 0.3);
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    }

    .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(16, 185, 129, 0.3);
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
    }

    .btn-toggle-activo:active {
        transform: translateY(0);
    }

    /* Estado en celda */
    td[id^="estado-"] {
        font-weight: 600;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .card-body-custom {
            padding: 25px 20px;
        }

        .table thead th,
        .table tbody td {
            padding: 12px 15px;
            font-size: 13px;
        }

        .btn-back {
            width: 100%;
            justify-content: center;
        }

        .btn-toggle-activo {
            padding: 6px 16px;
            font-size: 11px;
        }

        /* Hacer scroll horizontal en móviles */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .table {
            min-width: 700px;
        }
    }

    @media (max-width: 576px) {
        .card-header-custom h4 {
            font-size: 20px;
        }

        .btn-back {
            padding: 10px 20px;
            font-size: 13px;
        }
    }

    /* Animación de carga en botones */
    .btn-toggle-activo.loading {
        opacity: 0.6;
        pointer-events: none;
    }

    .btn-toggle-activo.loading::after {
        content: '';
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
        margin-left: 8px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="management-card">
        <div class="card-header-custom">
            <h4>Gestión de Remitentes</h4>
        </div>
        <div class="card-body-custom">
            
            <a href="{% url 'core:captura_documento' %}" class="btn-back">
                <i class="fas fa-arrow-left"></i>
                Volver a la captura
            </a>

            {# Tabla que muestra todos los remitentes, activos e inactivos #}
            <div class="table-responsive table-container">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th scope="col">Trato</th>
                            <th scope="col">Nombre</th>
                            <th scope="col">Área</th>
                            <th scope="col">Estado</th>
                            <th scope="col">Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                        {% for remitente in remitentes %}
                        {# La clase cambia según el estado: table-light para inactivos #}
                        <tr id="remitente-row-{{ remitente.pk }}" class="{% if not remitente.habilitado %}table-light{% endif %}">
                            <td><strong>{{ remitente.trato }}</strong></td>
                            <td>{{ remitente.nombre }}</td>
                            <td>{{ remitente.area|default:"N/A" }}</td>
                            <td id="estado-{{ remitente.pk }}">
                                {% if remitente.activo %}
                                    <span style="color: #10b981;">
                                        <i class="fas fa-check-circle"></i> Activo
                                    </span>
                                {% else %}
                                    <span style="color: #ef4444;">
                                        <i class="fas fa-times-circle"></i> Inactivo
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {# Lógica del botón según estado #}
                                {% if remitente.activo %}
                                    {# Si está Activo, el botón debe DESACTIVARLO #}
                                    <button class="btn btn-danger btn-sm btn-toggle-activo" data-id="{{ remitente.pk }}">
                                        <i class="fas fa-ban"></i>
                                        Deshabilitar
                                    </button>
                                {% else %}
                                    {# Si está Inactivo, el botón debe HABILITARLO #}
                                    <button class="btn btn-success btn-sm btn-toggle-activo" data-id="{{ remitente.pk }}">
                                        <i class="fas fa-check"></i>
                                        Habilitar
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center" style="padding: 40px 20px; color: #718096; font-style: italic;">
                                <i class="fas fa-user-slash fa-2x mb-2" style="color: #cbd5e0;"></i>
                                <br>
                                No hay remitentes registrados.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
// Función para obtener el token CSRF
function getCsrfToken() {
    return $('input[name="csrfmiddlewaretoken"]').val();
}

$(document).ready(function() {
    $(document).on('click', '.btn-toggle-activo', function(e) {
        e.preventDefault();
        
        const button = $(this);
        const remitenteId = button.data('id');
        
        // URL para toggle
        const url = `/remitente/toggle/${remitenteId}/`; 
        
        const row = button.closest('tr');
        const estadoCell = row.find('td').eq(3); 
        
        const csrfToken = getCsrfToken(); 

        // Añadir clase de loading
        button.addClass('loading');

        $.ajax({
            url: url,
            type: 'POST',
            data: { 
                'csrfmiddlewaretoken': csrfToken
            },
            success: function(response) {
                // Remover clase de loading
                button.removeClass('loading');
                
                if (response.status === 'success') {
                    
                    // Comprueba si el nuevo estado es ACTIVO (true)
                    if (response.activo === true) { 
                        // El remitente ahora está Activo
                        estadoCell.html('<span style="color: #10b981;"><i class="fas fa-check-circle"></i> Activo</span>');
                        button.html('<i class="fas fa-ban"></i> Deshabilitar').removeClass('btn-success').addClass('btn-danger');
                        row.removeClass('table-light');
                    } else if (response.activo === false) { 
                        // El remitente ahora está Inactivo
                        estadoCell.html('<span style="color: #ef4444;"><i class="fas fa-times-circle"></i> Inactivo</span>');
                        button.html('<i class="fas fa-check"></i> Habilitar').removeClass('btn-danger').addClass('btn-success');
                        row.addClass('table-light');
                    } else {
                        // Si el valor no es un booleano, recarga la página
                        window.location.reload(); 
                    }
                }
            },
            error: function(xhr, status, error) {
                // Remover clase de loading
                button.removeClass('loading');
                
                console.error('Error al cambiar el estado del remitente:', error);
                alert('Ocurrió un error al procesar la solicitud. Por favor, intente nuevamente.');
            }
        });
    });
});
</script>
{% endblock extra_js %}